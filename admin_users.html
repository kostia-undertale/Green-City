{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
    <div>
        <a href="{{ url_for('admin_cities') }}" class="btn btn-outline-primary">üèôÔ∏è –ì–æ—Ä–æ–¥–∞</a>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </div>
</div>

<!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">
            <i class="fas fa-search me-2"></i>–ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <div class="mb-3">
                    <label class="form-label">–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email:</label>
                    <div class="input-group">
                        <input type="text" id="searchInput" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–ª–∏ email...">
                        <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <label class="form-label">–§–∏–ª—å—Ç—Ä –ø–æ —Ä–æ–ª–∏:</label>
                    <select class="form-select" id="roleFilter">
                        <option value="">–í—Å–µ —Ä–æ–ª–∏</option>
                        <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                        <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                        <option value="creator">–°–æ–∑–¥–∞—Ç–µ–ª—å</option>
                    </select>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <label class="form-label">–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É:</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                        <option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span class="text-muted" id="searchResultsText">
                    –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <strong>{{ users|length }}</strong>
                </span>
            </div>
            <div>
                <button class="btn btn-outline-secondary btn-sm" id="resetFilters">
                    <i class="fas fa-refresh me-1"></i>–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
<div class="card">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–∏—Å—Ç–µ–º—ã
        </h5>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
            <label class="form-check-label text-white" for="autoRefresh">–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</label>
        </div>
    </div>
    <div class="card-body">
        {% if users %}
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="usersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>
                            –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                            <i class="fas fa-sort ms-1 cursor-pointer" data-sort="username"></i>
                        </th>
                        <th>Email</th>
                        <th>
                            –ì–æ—Ä–æ–¥
                            <i class="fas fa-sort ms-1 cursor-pointer" data-sort="city"></i>
                        </th>
                        <th>
                            –†–æ–ª—å
                            <i class="fas fa-sort ms-1 cursor-pointer" data-sort="role"></i>
                        </th>
                        <th>
                            –°—Ç–∞—Ç—É—Å
                            <i class="fas fa-sort ms-1 cursor-pointer" data-sort="status"></i>
                        </th>
                        <th>
                            –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                            <i class="fas fa-sort ms-1 cursor-pointer" data-sort="date"></i>
                        </th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    {% for user in users %}
                    <tr class="user-row"
                        data-username="{{ user.username.lower() }}"
                        data-email="{{ user.email.lower() }}"
                        data-city="{{ user.city }}"
                        data-role="{{ user.role }}"
                        data-status="{{ 'active' if user.is_active else 'inactive' }}">
                        <td>{{ user.id }}</td>
                        <td>
                            <a href="{{ url_for('view_profile', user_id=user.id) }}" class="text-decoration-none">
                                <strong class="user-username">{{ user.username }}</strong>
                                {% if user.id == session.user_id %}<strong>(–í—ã)</strong>{% endif %}
                            </a>
                        </td>
                        <td class="user-email">{{ user.email }}</td>
                        <td class="user-city">{{ user.city }}</td>
                        <td class="user-role">
                            <span class="badge bg-{{ 'danger' if user.role == 'admin' else 'warning' if user.role == 'creator' else 'secondary' }}">
                                {{ user.role }}
                            </span>
                        </td>
                        <td class="user-status">
                            <span class="badge bg-{{ 'success' if user.is_active else 'danger' }}">
                                {{ '–ê–∫—Ç–∏–≤–µ–Ω' if user.is_active else '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω' }}
                            </span>
                        </td>
                        <td class="user-date">{{ user.created_date[:10] }}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                {% if user.id != session.user_id %}
                                    {% if session.role == 'creator' %}
                                        <!-- –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å —Ä–æ–ª–∏ -->
                                        {% if user.role != 'creator' %}
                                        <a href="{{ url_for('toggle_user_role', user_id=user.id) }}"
                                           class="btn btn-{{ 'warning' if user.role == 'admin' else 'info' }}"
                                           onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ user.username }}?')">
                                            {{ '–°–Ω—è—Ç—å –∞–¥–º–∏–Ω–∞' if user.role == 'admin' else '–°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º' }}
                                        </a>
                                        {% endif %}
                                    {% endif %}

                                    <!-- –ê–∫—Ç–∏–≤–∞—Ü–∏—è/–¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è -->
                                    {% if session.role == 'creator' or (session.role == 'admin' and user.role == 'user') %}
                                    <a href="{{ url_for('toggle_user_status', user_id=user.id) }}"
                                       class="btn btn-{{ 'danger' if user.is_active else 'success' }}"
                                       onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ {{ '–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' if user.is_active else '–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ user.username }}?')">
                                        {{ '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' if user.is_active else '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' }}
                                    </a>
                                    {% else %}
                                    <span class="text-muted small">–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∞</span>
                                    {% endif %}
                                {% else %}
                                <span class="text-muted">–í–∞—à –∞–∫–∫–∞—É–Ω—Ç</span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div id="noResults" class="text-center py-4 d-none">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h5>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h5>
            <p class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-users fa-3x text-muted mb-3"></i>
            <h5>–ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h5>
            <p class="text-muted">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="card mt-4">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h4 id="totalUsers">{{ users|length }}</h4>
                        <p class="mb-0">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h4 id="activeUsers">{{ users|selectattr('is_active', 'equalto', 1)|list|length }}</h4>
                        <p class="mb-0">–ê–∫—Ç–∏–≤–Ω—ã—Ö</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h4 id="adminUsers">{{ users|selectattr('role', 'equalto', 'admin')|list|length }}</h4>
                        <p class="mb-0">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h4 id="regularUsers">{{ users|selectattr('role', 'equalto', 'user')|list|length }}</h4>
                        <p class="mb-0">–û–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const roleFilter = document.getElementById('roleFilter');
    const statusFilter = document.getElementById('statusFilter');
    const clearSearch = document.getElementById('clearSearch');
    const resetFilters = document.getElementById('resetFilters');
    const usersTableBody = document.getElementById('usersTableBody');
    const noResults = document.getElementById('noResults');
    const searchResultsText = document.getElementById('searchResultsText');
    const autoRefresh = document.getElementById('autoRefresh');

    let currentSort = { column: 'username', direction: 'asc' };

    // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    function filterUsers() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const roleValue = roleFilter.value;
        const statusValue = statusFilter.value;

        let visibleCount = 0;
        let activeCount = 0;
        let adminCount = 0;
        let regularCount = 0;

        document.querySelectorAll('.user-row').forEach(row => {
            const username = row.getAttribute('data-username');
            const email = row.getAttribute('data-email');
            const userRole = row.getAttribute('data-role');
            const userStatus = row.getAttribute('data-status');

            const matchesSearch = searchTerm === '' ||
                                username.includes(searchTerm) ||
                                email.includes(searchTerm);
            const matchesRole = roleValue === '' || userRole === roleValue;
            const matchesStatus = statusValue === '' || userStatus === statusValue;

            if (matchesSearch && matchesRole && matchesStatus) {
                row.style.display = '';
                visibleCount++;

                // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                if (userStatus === 'active') activeCount++;
                if (userRole === 'admin') adminCount++;
                if (userRole === 'user') regularCount++;
            } else {
                row.style.display = 'none';
            }
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        searchResultsText.innerHTML = `–ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <strong>${visibleCount}</strong>`;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        document.getElementById('totalUsers').textContent = visibleCount;
        document.getElementById('activeUsers').textContent = activeCount;
        document.getElementById('adminUsers').textContent = adminCount;
        document.getElementById('regularUsers').textContent = regularCount;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"
        if (visibleCount === 0) {
            noResults.classList.remove('d-none');
            usersTableBody.style.display = 'none';
        } else {
            noResults.classList.add('d-none');
            usersTableBody.style.display = '';
        }
    }

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
    function sortTable(column, direction) {
        const rows = Array.from(document.querySelectorAll('.user-row:not([style*="display: none"])'));

        rows.sort((a, b) => {
            let aValue, bValue;

            switch(column) {
                case 'username':
                    aValue = a.querySelector('.user-username').textContent.toLowerCase();
                    bValue = b.querySelector('.user-username').textContent.toLowerCase();
                    break;
                case 'city':
                    aValue = a.querySelector('.user-city').textContent.toLowerCase();
                    bValue = b.querySelector('.user-city').textContent.toLowerCase();
                    break;
                case 'role':
                    aValue = a.querySelector('.user-role').textContent.toLowerCase();
                    bValue = b.querySelector('.user-role').textContent.toLowerCase();
                    break;
                case 'status':
                    aValue = a.querySelector('.user-status').textContent.toLowerCase();
                    bValue = b.querySelector('.user-status').textContent.toLowerCase();
                    break;
                case 'date':
                    aValue = new Date(a.querySelector('.user-date').textContent);
                    bValue = new Date(b.querySelector('.user-date').textContent);
                    break;
                default:
                    return 0;
            }

            if (direction === 'asc') {
                return aValue > bValue ? 1 : -1;
            } else {
                return aValue < bValue ? 1 : -1;
            }
        });

        // –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
        const tbody = document.getElementById('usersTableBody');
        rows.forEach(row => tbody.appendChild(row));
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    searchInput.addEventListener('input', function() {
        if (autoRefresh.checked) {
            filterUsers();
        }
    });

    roleFilter.addEventListener('change', function() {
        if (autoRefresh.checked) {
            filterUsers();
        }
    });

    statusFilter.addEventListener('change', function() {
        if (autoRefresh.checked) {
            filterUsers();
        }
    });

    clearSearch.addEventListener('click', function() {
        searchInput.value = '';
        if (autoRefresh.checked) {
            filterUsers();
        }
    });

    resetFilters.addEventListener('click', function() {
        searchInput.value = '';
        roleFilter.value = '';
        statusFilter.value = '';
        filterUsers();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    document.querySelectorAll('[data-sort]').forEach(icon => {
        icon.addEventListener('click', function() {
            const column = this.getAttribute('data-sort');
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            sortTable(currentSort.column, currentSort.direction);

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            document.querySelectorAll('[data-sort]').forEach(i => {
                i.className = 'fas fa-sort ms-1 cursor-pointer';
            });
            this.className = `fas fa-sort-${currentSort.direction === 'asc' ? 'up' : 'down'} ms-1 cursor-pointer`;
        });
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    filterUsers();
});
</script>

<style>
.cursor-pointer {
    cursor: pointer;
}

.user-row:hover {
    background-color: #f8f9fa !important;
}

.input-group .btn {
    border-left: none;
}

.table th {
    background-color: #f8f9fa;
    position: relative;
}

.table th i {
    opacity: 0.5;
    transition: opacity 0.2s;
}

.table th i:hover {
    opacity: 1;
}

#noResults {
    background-color: #f8f9fa;
    border-radius: 8px;
}

.badge {
    font-size: 0.75em;
}
</style>
{% endblock %}