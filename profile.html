{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üë§ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
    <div>
        {% if session.role == 'admin' and not is_own_profile %}
        <a href="{{ url_for('admin_users') }}" class="btn btn-outline-primary">‚Üê –ö —Å–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</a>
        {% endif %}
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h5>
            </div>
            <div class="card-body">
                <table class="table">
                    <tr>
                        <th>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</th>
                        <td>{{ user.username }}</td>
                    </tr>
                    <tr>
                        <th>Email:</th>
                        <td>{{ user.email }}</td>
                    </tr>
                    <tr>
                        <th>–ì–æ—Ä–æ–¥:</th>
                        <td>
                            {{ user.city }}
                            {% if is_own_profile %}
                            <button type="button" class="btn btn-sm btn-outline-primary ms-2" data-bs-toggle="modal" data-bs-target="#changeCityModal">
                                <i class="fas fa-edit me-1"></i>–ò–∑–º–µ–Ω–∏—Ç—å
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>–†–æ–ª—å:</th>
                        <td>
                            <span class="badge bg-{{ 'danger' if user.role == 'admin' else 'secondary' }}">
                                {{ user.role }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <th>–°—Ç–∞—Ç—É—Å:</th>
                        <td>
                            <span class="badge bg-{{ 'success' if user.is_active else 'danger' }}">
                                {{ '–ê–∫—Ç–∏–≤–µ–Ω' if user.is_active else '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω' }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</th>
                        <td>{{ user.created_date[:10] }}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h5>
            </div>
            <div class="card-body">
                <div class="card bg-light mb-3">
                    <div class="card-body text-center">
                        <h3 class="text-primary">{{ stats.zones_added }}</h3>
                        <p class="mb-0">–î–æ–±–∞–≤–ª–µ–Ω–æ –∑–µ–ª–µ–Ω—ã—Ö –∑–æ–Ω</p>
                    </div>
                </div>
                <div class="card bg-light mb-3">
                    <div class="card-body text-center">
                        <h3 class="text-success">{{ stats.reports_submitted }}</h3>
                        <p class="mb-0">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –æ—Ç—á–µ—Ç–æ–≤</p>
                    </div>
                </div>
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h3 class="text-info">{{ stats.tasks_created }}</h3>
                        <p class="mb-0">–°–æ–∑–¥–∞–Ω–æ –∑–∞–¥–∞—á</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if is_own_profile %}
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–º–µ–Ω—ã –≥–æ—Ä–æ–¥–∞ -->
<div class="modal fade" id="changeCityModal" tabindex="-1" aria-labelledby="changeCityModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="changeCityModalLabel">
                    <i class="fas fa-city me-2"></i>–°–º–µ–Ω–∞ –≥–æ—Ä–æ–¥–∞
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{{ url_for('change_city') }}">
                    <div class="mb-3">
                        <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –≥–æ—Ä–æ–¥:</label>
                        <select name="new_city" class="form-select" required size="8">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ --</option>
                            {% for region, cities in cities_by_region.items() %}
                            <optgroup label="{{ region }}">
                                {% for city in cities %}
                                <option value="{{ city.name }}" {% if city.name == user.city %}selected{% endif %}>
                                    {{ city.name }}
                                </option>
                                {% endfor %}
                            </optgroup>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            –ü–æ—Å–ª–µ —Å–º–µ–Ω—ã –≥–æ—Ä–æ–¥–∞ –≤—ã –±—É–¥–µ—Ç–µ –≤–∏–¥–µ—Ç—å —Ç–æ–ª—å–∫–æ –∑–µ–ª–µ–Ω—ã–µ –∑–æ–Ω—ã –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –°–º–µ–Ω–∞ –≥–æ—Ä–æ–¥–∞ –ø–æ–≤–ª–∏—è–µ—Ç –Ω–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:
                        <ul class="mb-0 mt-2">
                            <li>–ù–∞ –∫–∞—Ä—Ç–µ –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–ª—å–∫–æ –∑–æ–Ω—ã –Ω–æ–≤–æ–≥–æ –≥–æ—Ä–æ–¥–∞</li>
                            <li>–í –æ—Ç—á–µ—Ç–∞—Ö –±—É–¥–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–æ–ª—å–∫–æ –ø–æ –Ω–æ–≤–æ–º—É –≥–æ—Ä–æ–¥—É</li>
                            <li>–í—ã —Å–º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å –∑–æ–Ω—ã —Ç–æ–ª—å–∫–æ –≤ –Ω–æ–≤—ã–π –≥–æ—Ä–æ–¥</li>
                        </ul>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-check me-1"></i>–°–º–µ–Ω–∏—Ç—å –≥–æ—Ä–æ–¥
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>–û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if session.role == 'admin' and not is_own_profile %}
<div class="card mt-4">
    <div class="card-header bg-warning">
        <h5 class="mb-0">‚öôÔ∏è –î–µ–π—Å—Ç–≤–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h5>
    </div>
    <div class="card-body">
        <div class="btn-group">
            <a href="{{ url_for('toggle_user_role', user_id=user.id) }}"
               class="btn btn-{{ 'warning' if user.role == 'admin' else 'info' }}"
               onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ user.username }}?')">
                {{ '–°–Ω—è—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' if user.role == 'admin' else '–ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º' }}
            </a>
            <a href="{{ url_for('toggle_user_status', user_id=user.id) }}"
               class="btn btn-{{ 'danger' if user.is_active else 'success' }}"
               onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ {{ '–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' if user.is_active else '–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ user.username }}?')">
                {{ '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' if user.is_active else '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' }}
            </a>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}