{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-plus-circle me-2"></i>Добавить новую зеленую зону
                </h4>
            </div>
            <div class="card-body">
                <form method="POST" id="zoneForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-tag me-1"></i>Название зоны:
                                </label>
                                <input type="text" name="name" class="form-control"
                                       placeholder="Например: Центральный парк" required
                                       id="zoneName">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-list me-1"></i>Тип зоны:
                                </label>
                                <select name="zone_type" class="form-select" required id="zoneType">
                                    <option value="">Выберите тип...</option>
                                    <option value="Парк">Парк</option>
                                    <option value="Сквер">Сквер</option>
                                    <option value="Аллея">Аллея</option>
                                    <option value="Детская площадка">Детская площадка</option>
                                    <option value="Спортивная площадка">Спортивная площадка</option>
                                    <option value="Газон">Газон</option>
                                    <option value="Цветник">Цветник</option>
                                    <option value="Лесопарк">Лесопарк</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-ruler-combined me-1"></i>Площадь (гектары):
                                </label>
                                <input type="number" name="area" class="form-control"
                                       step="0.1" min="0.1" placeholder="Например: 5.2" required
                                       id="zoneArea">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-map-marker-alt me-1"></i>Местоположение (адрес):
                                </label>
                                <input type="text" name="location" class="form-control"
                                       placeholder="Адрес будет определен автоматически по координатам" required
                                       id="zoneLocation" readonly>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>Адрес автоматически определится при выборе точки на карте
                                </div>
                            </div>

                            <!-- Скрытое поле для координат -->
                            <input type="hidden" name="coordinates" id="zoneCoordinates" required>

                            {% if session.role in ['admin', 'creator'] %}
                            <div class="alert alert-success">
                                <i class="fas fa-shield-alt me-2"></i>
                                <strong>Вы администратор</strong> - зона будет автоматически одобрена
                            </div>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-clock me-2"></i>
                                <strong>Внимание:</strong> Зона будет отправлена на модерацию администратору.
                                После проверки она появится на карте.
                            </div>
                            {% endif %}

                            <div class="alert alert-info">
                                <h6>
                                    <i class="fas fa-info-circle me-2"></i>Инструкция:
                                </h6>
                                <ol class="mb-0">
                                    <li>Заполните информацию о зоне</li>
                                    <li>Нажмите на карту в том месте, где хотите разместить зону</li>
                                    <li>Маркер появится в выбранном месте</li>
                                    <li>Адрес определится автоматически</li>
                                    <li>Нажмите кнопку "Создать зону"</li>
                                </ol>
                            </div>

                            <div id="coordinatesInfo" class="alert alert-warning d-none">
                                <i class="fas fa-map-pin me-2"></i>
                                <strong>Выбранные координаты:</strong>
                                <span id="coordinatesText">Не выбраны</span>
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a href="{{ url_for('map_view') }}" class="btn btn-secondary me-md-2">
                                    <i class="fas fa-arrow-left me-1"></i>Отмена
                                </a>
                                <button type="submit" class="btn btn-success" id="submitBtn" disabled>
                                    <i class="fas fa-check me-1"></i>
                                    {% if session.role in ['admin', 'creator'] %}
                                    Создать зону
                                    {% else %}
                                    Отправить на модерацию
                                    {% endif %}
                                </button>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-map me-2"></i>Выберите местоположение на карте
                                    </h5>
                                </div>
                                <div class="card-body p-0">
                                    <div id="zoneMap" style="height: 400px; border-radius: 0 0 8px 8px;"></div>
                                </div>
                            </div>

                            <div class="card mt-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">
                                        <i class="fas fa-crosshairs me-2"></i>Текущий маркер
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div id="markerInfo" class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Нажмите на карту чтобы разместить маркер
                                    </div>
                                    <div id="addressInfo" class="mt-2 d-none">
                                        <i class="fas fa-home me-1"></i>
                                        <strong>Адрес:</strong> <span id="addressText">Определяется...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Подключаем Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Функция для геокодирования координат в адрес через наш API
async function reverseGeocode(lat, lon) {
    try {
        const response = await fetch(`/api/reverse_geocode?lat=${lat}&lon=${lon}`);
        const data = await response.json();

        if (data.success) {
            return data.address;
        } else {
            console.error('Ошибка геокодирования:', data.message);
            return null;
        }
    } catch (error) {
        console.error('Ошибка сети:', error);
        return null;
    }
}

// Инициализация карты
function initMap() {
    // Центр карты - город пользователя или Москва по умолчанию
    var userCity = "{{ user_city }}";
    var defaultCoords = "{{ default_coords }}";

    var centerLat = 55.7558;
    var centerLon = 37.6173;
    var zoom = 10;

    // Если есть координаты города, используем их
    if (defaultCoords) {
        var coords = defaultCoords.split(',');
        centerLat = parseFloat(coords[0]);
        centerLon = parseFloat(coords[1]);
        zoom = 12;
    }

    // Создаем карту с отключенной атрибуцией
    var map = L.map('zoneMap', {
        attributionControl: false
    }).setView([centerLat, centerLon], zoom);

    // Добавляем слой 2GIS
    L.tileLayer('https://tile2.maps.2gis.com/tiles?x={x}&y={y}&z={z}&v=1', {
        maxZoom: 18
    }).addTo(map);

    // Переменные для маркера
    var marker = null;
    var currentCoordinates = null;

    // Обработчик клика на карту
    map.on('click', async function(e) {
        var lat = e.latlng.lat;
        var lon = e.latlng.lng;
        currentCoordinates = lat.toFixed(6) + ',' + lon.toFixed(6);

        // Удаляем старый маркер если есть
        if (marker) {
            map.removeLayer(marker);
        }

        // Создаем новый маркер
        marker = L.marker([lat, lon])
            .addTo(map)
            .bindPopup('Новая зеленая зона<br>Определяем адрес...')
            .openPopup();

        // Обновляем информацию о координатах
        document.getElementById('zoneCoordinates').value = currentCoordinates;
        document.getElementById('coordinatesText').textContent = currentCoordinates;
        document.getElementById('coordinatesInfo').classList.remove('d-none');

        // Показываем загрузку адреса
        document.getElementById('addressInfo').classList.remove('d-none');
        document.getElementById('addressText').textContent = 'Определяется...';
        document.getElementById('zoneLocation').value = 'Определяется адрес...';

        // Обновляем информацию о маркере
        document.getElementById('markerInfo').innerHTML = `
            <div class="text-success">
                <i class="fas fa-check-circle me-1"></i>
                <strong>Маркер установлен</strong>
                <br>
                <small>Координаты: ${currentCoordinates}</small>
            </div>
        `;

        // Активируем кнопку отправки (временно, пока определяется адрес)
        document.getElementById('submitBtn').disabled = false;

        // Получаем адрес по координатам
        try {
            const address = await reverseGeocode(lat, lon);
            if (address) {
                document.getElementById('zoneLocation').value = address;
                document.getElementById('addressText').textContent = address;

                // Обновляем popup маркера
                marker.setPopupContent(`<b>Новая зеленая зона</b><br>${address}`);
            } else {
                // Если адрес не найден, используем координаты
                const fallbackAddress = `Координаты: ${currentCoordinates}`;
                document.getElementById('zoneLocation').value = fallbackAddress;
                document.getElementById('addressText').textContent = 'Адрес не найден, используются координаты';
                marker.setPopupContent(`<b>Новая зеленая зона</b><br>${fallbackAddress}`);
            }
        } catch (error) {
            console.error('Ошибка при получении адреса:', error);
            // В случае ошибки используем координаты
            const fallbackAddress = `Координаты: ${currentCoordinates}`;
            document.getElementById('zoneLocation').value = fallbackAddress;
            document.getElementById('addressText').textContent = 'Ошибка определения адреса, используются координаты';
            marker.setPopupContent(`<b>Новая зеленая зона</b><br>${fallbackAddress}`);
        }

        // Предлагаем автоматическое название на основе координат
        if (!document.getElementById('zoneName').value) {
            var zoneType = document.getElementById('zoneType').value;
            var typeName = zoneType ? zoneType + ' ' : 'Зеленая зона ';
            document.getElementById('zoneName').value = typeName + ' (' + currentCoordinates + ')';
        }
    });

    // Добавляем масштаб
    L.control.scale({imperial: false}).addTo(map);

    // Обработчик отправки формы
    document.getElementById('zoneForm').addEventListener('submit', function(e) {
        if (!currentCoordinates) {
            e.preventDefault();
            alert('Пожалуйста, выберите местоположение на карте!');
            return false;
        }

        // Проверяем что адрес определился
        var locationField = document.getElementById('zoneLocation');
        if (locationField.value === 'Определяется адрес...' || !locationField.value.trim()) {
            e.preventDefault();
            alert('Пожалуйста, дождитесь определения адреса!');
            return false;
        }

        // Показываем подтверждение
        var zoneName = document.getElementById('zoneName').value;
        var userRole = "{{ session.role }}";
        var message = '';

        if (userRole === 'admin' || userRole === 'creator') {
            message = `Создать зеленую зону "${zoneName}" по адресу:\n${locationField.value}?`;
        } else {
            message = `Отправить зеленую зону "${zoneName}" на модерацию по адресу:\n${locationField.value}?`;
        }

        if (!confirm(message)) {
            e.preventDefault();
            return false;
        }
    });

    // Автозаполнение при выборе типа зоны
    document.getElementById('zoneType').addEventListener('change', function() {
        if (!document.getElementById('zoneName').value) {
            var zoneType = this.value;
            if (zoneType) {
                var typeNames = {
                    'Парк': 'Центральный парк',
                    'Сквер': 'Городской сквер',
                    'Аллея': 'Аллея Славы',
                    'Детская площадка': 'Детская площадка',
                    'Спортивная площадка': 'Спортивная площадка',
                    'Газон': 'Газон',
                    'Цветник': 'Цветник',
                    'Лесопарк': 'Лесопарк'
                };
                document.getElementById('zoneName').value = typeNames[zoneType] || zoneType;
            }
        }

        // Автоматическая площадь по типу
        if (!document.getElementById('zoneArea').value) {
            var defaultAreas = {
                'Парк': 5.0,
                'Сквер': 1.5,
                'Аллея': 0.8,
                'Детская площадка': 0.3,
                'Спортивная площадка': 0.5,
                'Газон': 0.2,
                'Цветник': 0.1,
                'Лесопарк': 10.0
            };
            var area = defaultAreas[this.value];
            if (area) {
                document.getElementById('zoneArea').value = area;
            }
        }
    });
}

// Инициализируем карту после загрузки страницы
document.addEventListener('DOMContentLoaded', initMap);
</script>
{% endblock %}