{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á–µ—Ç—ã</h2>
    {% if user_city %}
    <span class="badge bg-info fs-6">–ì–æ—Ä–æ–¥: {{ user_city }}</span>
    {% endif %}
</div>

<div class="row">
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–¥–∞—á–∞–º -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">üìã –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–¥–∞—á</h5>
            </div>
            <div class="card-body">
                {% if task_stats %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>–¢–∏–ø –∑–∞–¥–∞—á–∏</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in task_stats %}
                            <tr>
                                <td>
                                    {% if stat.task_type == 'watering' %}üíß –ü–æ–ª–∏–≤
                                    {% elif stat.task_type == 'pruning' %}‚úÇÔ∏è –û–±—Ä–µ–∑–∫–∞
                                    {% elif stat.task_type == 'cleaning' %}üßπ –£–±–æ—Ä–∫–∞
                                    {% elif stat.task_type == 'repair' %}üîß –†–µ–º–æ–Ω—Ç
                                    {% else %}{{ stat.task_type }}{% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'success' if stat.status == 'completed' else 'warning' if stat.status == 'in_progress' else 'secondary' }}">
                                        {% if stat.status == 'pending' %}‚è≥ –û–∂–∏–¥–∞–µ—Ç
                                        {% elif stat.status == 'in_progress' %}üîÑ –í —Ä–∞–±–æ—Ç–µ
                                        {% elif stat.status == 'completed' %}‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∞
                                        {% else %}{{ stat.status }}{% endif %}
                                    </span>
                                </td>
                                <td><strong>{{ stat.count }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–¥–∞—á–∞—Ö</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–µ–ª–µ–Ω—ã—Ö –∑–æ–Ω -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">üåø –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–µ–ª–µ–Ω—ã—Ö –∑–æ–Ω</h5>
            </div>
            <div class="card-body">
                {% if health_stats %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–æ–Ω</th>
                                <th>–ü—Ä–æ—Ü–µ–Ω—Ç</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set total_zones = health_stats | sum(attribute='count') %}
                            {% for stat in health_stats %}
                            <tr>
                                <td>
                                    <span class="badge bg-{{ 'success' if stat.health_category == '–û—Ç–ª–∏—á–Ω–æ' else 'warning' if stat.health_category == '–•–æ—Ä–æ—à–æ' else 'info' if stat.health_category == '–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ' else 'danger' }}">
                                        {{ stat.health_category }}
                                    </span>
                                </td>
                                <td><strong>{{ stat.count }}</strong></td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-{{ 'success' if stat.health_category == '–û—Ç–ª–∏—á–Ω–æ' else 'warning' if stat.health_category == '–•–æ—Ä–æ—à–æ' else 'info' if stat.health_category == '–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ' else 'danger' }}"
                                             style="width: {{ (stat.count / total_zones * 100) if total_zones > 0 else 0 }}%">
                                            {{ "%.1f"|format((stat.count / total_zones * 100) if total_zones > 0 else 0) }}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∑–æ–Ω</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –∑–æ–Ω—ã -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">üö® –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –∑–æ–Ω—ã (—Ç—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è)</h5>
            </div>
            <div class="card-body">
                {% if problem_zones %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ –∑–æ–Ω—ã</th>
                                {% if not user_city %}<th>–ì–æ—Ä–æ–¥</th>{% endif %}
                                <th>–°–æ—Å—Ç–æ—è–Ω–∏–µ</th>
                                <th>–û–∂–∏–¥–∞—é—â–∏–µ –∑–∞–¥–∞—á–∏</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for zone in problem_zones %}
                            <tr>
                                <td><strong>{{ zone.name }}</strong></td>
                                {% if not user_city %}
                                <td>{{ zone.city_name }}</td>
                                {% endif %}
                                <td>
                                    <span class="badge bg-{{ 'success' if (zone.avg_health or 0) >= 80 else 'warning' if (zone.avg_health or 0) >= 60 else 'danger' }}">
                                        {{ "%.1f"|format(zone.avg_health or 0) }}%
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'danger' if zone.pending_tasks > 0 else 'secondary' }}">
                                        {{ zone.pending_tasks }}
                                    </span>
                                </td>
                                <td>
                                    {% if (zone.avg_health or 0) < 40 %}
                                    <span class="badge bg-danger">üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ</span>
                                    {% elif (zone.avg_health or 0) < 60 %}
                                    <span class="badge bg-warning">üü° –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è</span>
                                    {% else %}
                                    <span class="badge bg-info">üîµ –ù–∞–±–ª—é–¥–µ–Ω–∏–µ</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if zone.id %}
                                    <a href="/zone/{{ zone.id }}" class="btn btn-sm btn-outline-primary">
                                        üëÄ –ü—Ä–æ—Å–º–æ—Ç—Ä
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <div class="text-success mb-3">
                        <i class="fas fa-check-circle fa-3x"></i>
                    </div>
                    <h5>–û—Ç–ª–∏—á–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏! üéâ</h5>
                    <p class="text-muted">–ù–µ—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–æ–Ω, —Ç—Ä–µ–±—É—é—â–∏—Ö —Å—Ä–æ—á–Ω–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card bg-light">
            <div class="card-body text-center">
                <h3 class="text-primary">{{ task_stats | sum(attribute='count') }}</h3>
                <p class="mb-0">–í—Å–µ–≥–æ –∑–∞–¥–∞—á –≤ —Å–∏—Å—Ç–µ–º–µ</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-light">
            <div class="card-body text-center">
                <h3 class="text-success">{{ health_stats | sum(attribute='count') }}</h3>
                <p class="mb-0">–í—Å–µ–≥–æ –æ—Ü–µ–Ω–µ–Ω–Ω—ã—Ö –∑–æ–Ω</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-light">
            <div class="card-body text-center">
                <h3 class="text-warning">{{ problem_zones | length }}</h3>
                <p class="mb-0">–ü—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–æ–Ω</p>
            </div>
        </div>
    </div>
</div>

<!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
{% if problem_zones %}
<div class="card mt-4 border-warning">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h5>
    </div>
    <div class="card-body">
        <ul class="list-unstyled">
            <li>‚úÖ <strong>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:</strong> –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∑–æ–Ω—ã —Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º</li>
            <li>üìù <strong>–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:</strong> –°–æ—Å—Ç–∞–≤—å—Ç–µ –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç –¥–ª—è –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–æ–Ω</li>
            <li>üë• <strong>–í–æ–≤–ª–µ—á–µ–Ω–∏–µ:</strong> –ü—Ä–∏–≤–ª–µ–∫–∏—Ç–µ –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–≤ –¥–ª—è –ø–æ–º–æ—â–∏ –≤ —É—Ö–æ–¥–µ</li>
            <li>üí∞ <strong>–ë—é–¥–∂–µ—Ç:</strong> –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è</li>
        </ul>
    </div>
</div>
{% endif %}

<style>
.progress {
    background-color: #f8f9fa;
    border-radius: 10px;
}
.progress-bar {
    border-radius: 10px;
    font-size: 12px;
    line-height: 20px;
}
</style>
{% endblock %}