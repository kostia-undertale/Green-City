{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üëë –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏</h2>
    <div>
        <a href="{{ url_for('admin_users') }}" class="btn btn-outline-primary">üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </div>
</div>

<!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">
            <i class="fas fa-search me-2"></i>–ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email:</label>
                    <div class="input-group">
                        <input type="text" id="searchInput" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–ª–∏ email...">
                        <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É:</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                        <option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span class="text-muted" id="searchResultsText">
                    –ù–∞–π–¥–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤: <strong>{{ admins|length }}</strong>
                </span>
            </div>
            <div>
                <button class="btn btn-outline-secondary btn-sm" id="resetFilters">
                    <i class="fas fa-refresh me-1"></i>–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                </button>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-crown me-2"></i>–°–æ–∑–¥–∞—Ç–µ–ª–∏ –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã —Å–∏—Å—Ç–µ–º—ã
        </h5>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
            <label class="form-check-label text-dark" for="autoRefresh">–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</label>
        </div>
    </div>
    <div class="card-body">
        {% if admins %}
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="adminsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>
                            –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                            <i class="fas fa-sort ms-1 cursor-pointer" data-sort="username"></i>
                        </th>
                        <th>Email</th>
                        <th>
                            –ì–æ—Ä–æ–¥
                            <i class="fas fa-sort ms-1 cursor-pointer" data-sort="city"></i>
                        </th>
                        <th>
                            –†–æ–ª—å
                            <i class="fas fa-sort ms-1 cursor-pointer" data-sort="role"></i>
                        </th>
                        <th>
                            –°—Ç–∞—Ç—É—Å
                            <i class="fas fa-sort ms-1 cursor-pointer" data-sort="status"></i>
                        </th>
                        <th>
                            –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                            <i class="fas fa-sort ms-1 cursor-pointer" data-sort="date"></i>
                        </th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="adminsTableBody">
                    {% for admin in admins %}
                    <tr class="admin-row"
                        data-username="{{ admin.username.lower() }}"
                        data-email="{{ admin.email.lower() }}"
                        data-city="{{ admin.city }}"
                        data-role="{{ admin.role }}"
                        data-status="{{ 'active' if admin.is_active else 'inactive' }}">
                        <td>{{ admin.id }}</td>
                        <td>
                            <a href="{{ url_for('view_profile', user_id=admin.id) }}" class="text-decoration-none">
                                <strong class="admin-username">{{ admin.username }}</strong>
                                {% if admin.id == session.user_id %}<strong>(–í—ã)</strong>{% endif %}
                            </a>
                        </td>
                        <td class="admin-email">{{ admin.email }}</td>
                        <td class="admin-city">{{ admin.city }}</td>
                        <td class="admin-role">
                            <span class="badge bg-{{ 'danger' if admin.role == 'creator' else 'warning' }}">
                                {% if admin.role == 'creator' %}üíé –°–æ–∑–¥–∞—Ç–µ–ª—å
                                {% else %}‚ö° –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
                                {% endif %}
                            </span>
                        </td>
                        <td class="admin-status">
                            <span class="badge bg-{{ 'success' if admin.is_active else 'danger' }}">
                                {{ '–ê–∫—Ç–∏–≤–µ–Ω' if admin.is_active else '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω' }}
                            </span>
                        </td>
                        <td class="admin-date">{{ admin.created_date[:10] }}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('view_user_actions', user_id=admin.id) }}"
                                   class="btn btn-info">
                                    üìä –î–µ–π—Å—Ç–≤–∏—è
                                </a>
                                {% if admin.id != session.user_id and admin.role != 'creator' %}
                                <a href="{{ url_for('toggle_user_role', user_id=admin.id) }}"
                                   class="btn btn-warning"
                                   onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–Ω—è—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å {{ admin.username }}?')">
                                    üë• –°–¥–µ–ª–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
                                </a>
                                <a href="{{ url_for('toggle_user_status', user_id=admin.id) }}"
                                   class="btn btn-{{ 'danger' if admin.is_active else 'success' }}"
                                   onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ {{ '–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' if admin.is_active else '–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' }} –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ {{ admin.username }}?')">
                                    {{ 'üö´ –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' if admin.is_active else '‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' }}
                                </a>
                                {% else %}
                                <span class="text-muted">–°–∏—Å—Ç–µ–º–Ω–∞—è —Ä–æ–ª—å</span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div id="noResults" class="text-center py-4 d-none">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h5>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h5>
            <p class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p>
        </div>
        {% else %}
        <p class="text-muted">–ù–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ</p>
        {% endif %}
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="card mt-4">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h4 id="totalAdmins">{{ admins|length }}</h4>
                        <p class="mb-0">–í—Å–µ–≥–æ –∞–¥–º–∏–Ω–æ–≤</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h4 id="creatorAdmins">{{ admins|selectattr('role', 'equalto', 'creator')|list|length }}</h4>
                        <p class="mb-0">–°–æ–∑–¥–∞—Ç–µ–ª–µ–π</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h4 id="adminAdmins">{{ admins|selectattr('role', 'equalto', 'admin')|list|length }}</h4>
                        <p class="mb-0">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h4 id="activeAdmins">{{ admins|selectattr('is_active', 'equalto', 1)|list|length }}</h4>
                        <p class="mb-0">–ê–∫—Ç–∏–≤–Ω—ã—Ö</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const clearSearch = document.getElementById('clearSearch');
    const resetFilters = document.getElementById('resetFilters');
    const adminsTableBody = document.getElementById('adminsTableBody');
    const noResults = document.getElementById('noResults');
    const searchResultsText = document.getElementById('searchResultsText');
    const autoRefresh = document.getElementById('autoRefresh');

    let currentSort = { column: 'username', direction: 'asc' };

    // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
    function filterAdmins() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const statusValue = statusFilter.value;

        let visibleCount = 0;
        let creatorCount = 0;
        let adminCount = 0;
        let activeCount = 0;

        document.querySelectorAll('.admin-row').forEach(row => {
            const username = row.getAttribute('data-username');
            const email = row.getAttribute('data-email');
            const adminRole = row.getAttribute('data-role');
            const adminStatus = row.getAttribute('data-status');

            const matchesSearch = searchTerm === '' ||
                                username.includes(searchTerm) ||
                                email.includes(searchTerm);
            const matchesStatus = statusValue === '' || adminStatus === statusValue;

            if (matchesSearch && matchesStatus) {
                row.style.display = '';
                visibleCount++;

                // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                if (adminRole === 'creator') creatorCount++;
                if (adminRole === 'admin') adminCount++;
                if (adminStatus === 'active') activeCount++;
            } else {
                row.style.display = 'none';
            }
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        searchResultsText.innerHTML = `–ù–∞–π–¥–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤: <strong>${visibleCount}</strong>`;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        document.getElementById('totalAdmins').textContent = visibleCount;
        document.getElementById('creatorAdmins').textContent = creatorCount;
        document.getElementById('adminAdmins').textContent = adminCount;
        document.getElementById('activeAdmins').textContent = activeCount;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"
        if (visibleCount === 0) {
            noResults.classList.remove('d-none');
            adminsTableBody.style.display = 'none';
        } else {
            noResults.classList.add('d-none');
            adminsTableBody.style.display = '';
        }
    }

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
    function sortTable(column, direction) {
        const rows = Array.from(document.querySelectorAll('.admin-row:not([style*="display: none"])'));

        rows.sort((a, b) => {
            let aValue, bValue;

            switch(column) {
                case 'username':
                    aValue = a.querySelector('.admin-username').textContent.toLowerCase();
                    bValue = b.querySelector('.admin-username').textContent.toLowerCase();
                    break;
                case 'city':
                    aValue = a.querySelector('.admin-city').textContent.toLowerCase();
                    bValue = b.querySelector('.admin-city').textContent.toLowerCase();
                    break;
                case 'role':
                    aValue = a.querySelector('.admin-role').textContent.toLowerCase();
                    bValue = b.querySelector('.admin-role').textContent.toLowerCase();
                    break;
                case 'status':
                    aValue = a.querySelector('.admin-status').textContent.toLowerCase();
                    bValue = b.querySelector('.admin-status').textContent.toLowerCase();
                    break;
                case 'date':
                    aValue = new Date(a.querySelector('.admin-date').textContent);
                    bValue = new Date(b.querySelector('.admin-date').textContent);
                    break;
                default:
                    return 0;
            }

            if (direction === 'asc') {
                return aValue > bValue ? 1 : -1;
            } else {
                return aValue < bValue ? 1 : -1;
            }
        });

        // –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
        const tbody = document.getElementById('adminsTableBody');
        rows.forEach(row => tbody.appendChild(row));
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    searchInput.addEventListener('input', function() {
        if (autoRefresh.checked) {
            filterAdmins();
        }
    });

    statusFilter.addEventListener('change', function() {
        if (autoRefresh.checked) {
            filterAdmins();
        }
    });

    clearSearch.addEventListener('click', function() {
        searchInput.value = '';
        if (autoRefresh.checked) {
            filterAdmins();
        }
    });

    resetFilters.addEventListener('click', function() {
        searchInput.value = '';
        statusFilter.value = '';
        filterAdmins();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    document.querySelectorAll('[data-sort]').forEach(icon => {
        icon.addEventListener('click', function() {
            const column = this.getAttribute('data-sort');
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            sortTable(currentSort.column, currentSort.direction);

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            document.querySelectorAll('[data-sort]').forEach(i => {
                i.className = 'fas fa-sort ms-1 cursor-pointer';
            });
            this.className = `fas fa-sort-${currentSort.direction === 'asc' ? 'up' : 'down'} ms-1 cursor-pointer`;
        });
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    filterAdmins();
});
</script>

<style>
.cursor-pointer {
    cursor: pointer;
}

.admin-row:hover {
    background-color: #f8f9fa !important;
}

.input-group .btn {
    border-left: none;
}

.table th {
    background-color: #f8f9fa;
    position: relative;
}

.table th i {
    opacity: 0.5;
    transition: opacity 0.2s;
}

.table th i:hover {
    opacity: 1;
}

#noResults {
    background-color: #f8f9fa;
    border-radius: 8px;
}

.badge {
    font-size: 0.75em;
}
</style>
{% endblock %}